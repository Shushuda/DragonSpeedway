# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

DragonSpeedway is a World of Warcraft addon that plays custom music and sound effects during Dragon Riding races. It's split into two addons:
- **DragonSpeedway** - Core logic, settings UI, race detection
- **DragonSpeedway_Music** - Music/sound file storage and LibSharedMedia registration (kept separate to prevent addon managers from overwriting user-added music files)

## Development & Testing

There is no build system - this is direct Lua scripting for WoW.

**Testing changes:**
1. Copy `DragonSpeedway/` and `DragonSpeedway_Music/` to `World of Warcraft/_retail_/Interface/AddOns/`
2. **Full game restart required** for new music files (not just `/reload`)
3. Test in-game via `/ds` (opens settings) or `/ds stop` (stops music)

**Adding custom music (Windows):**
```bash
cd DragonSpeedway_Music
mv registerFiles.bat.txt registerFiles.bat
./registerFiles.bat  # Generates DragonSpeedway-AutoGenerated.lua
```

**Race ID formatting utility:**
```bash
# Reads IDs.txt (comma-separated), outputs result.txt (Lua table format)
python DragonSpeedway-ID-generator.py
```

## Architecture

### Key Files
- `DragonSpeedway/DragonSpeedway.lua` - Core addon: race detection, music playback, camera control
- `DragonSpeedway/DragonSpeedway-Options.lua` - Settings panel UI
- `DragonSpeedway_Music/DragonSpeedway-LSM.lua` - Spyro music registration (predefined filenames)
- `DragonSpeedway_Music/DragonSpeedway-CustomMusic.lua` - Custom music registration template
- `DragonSpeedway_Music/DragonSpeedway-AutoGenerated.lua` - Auto-generated from .bat script

### Libraries (in `Libs/`)
- **LibSharedMedia-3.0** - Sound file registration and retrieval
- **MC2SchedulerLib** - Task scheduling/timers
- **LibStub** + **CallbackHandler-1.0** - Library loading and events

### Event-Driven Architecture
The addon monitors WoW events:
- `UNIT_AURA` - Detects race start/end via spell auras
- `LOADING_SCREEN_DISABLED` - Handles mount state on zone changes
- `ADDON_LOADED` - Initialization

### Race Detection
- Large lookup tables of spell IDs for races (~100+ entries) and dragon riding mounts (~40+ entries)
- Separate countdown spell ID detection
- Instance IDs tracked to properly clean up aura monitoring

### State Management
- Saves/restores global music and volume settings around races
- Mount state reconciliation prevents state desync after zone loads
- SavedVariables: `DragonSpeedwayDB` (per-character settings)

### Music System
- Three music groups: Spyro1, Spyro2, Spyro3, Custom
- Music tables dynamically built from LSM registry at startup
- Random selection from user-configured groups (All/Spyro/Custom)
- Validation via `LSM:IsValid()` on load

## File Formats

**Sound files:** `.mp3` or `.ogg` only

**LSM registration format:**
```lua
LSM:Register("sound", "Display Name", [[Interface\Addons\DragonSpeedway_Music\Music\Custom\filename.mp3]])
```

**Spyro music filenames are fixed** (see DragonSpeedway-LSM.lua or README.md for exact names).

## WoW Interface Version

Currently targets retail WoW (Interface version in .toc files). Update TOC `## Interface:` value when WoW patches break compatibility.

## Reference Documentation

The `wow-ui-source/` directory contains the latest WoW UI source code mirrored from Blizzard. This is **documentation only** - use it as a reference for WoW's Lua API, frame templates, and UI patterns. Do not modify files in this directory or treat them as part of this addon project.

## Web Resources

For WoW API lookups, prefer `wow-ui-source/` for source code reference. For wiki documentation, restrict web searches to `warcraft.wiki.gg`.

## WoW Midnight (12.0) Secret Values System

### When Aura Data Becomes Secret
| Context | Aura Data |
|---------|-----------|
| Overworld + no combat | Accessible |
| Overworld + combat | **Secret** |
| Instanced content (delves, dungeons, raids, arenas, BGs) | **Secret** (regardless of combat) |

### Detection APIs
- `issecretvalue(val)` - Returns true if value is a secret handle
- `canaccessvalue(val)` - Returns true if current execution can read the value
- `scrubsecretvalues(...)` - Returns args with secret values replaced by nil

### Safety Pattern
Always check before comparing:
```lua
if not issecretvalue(aura.spellId) and aura.spellId == TARGET_SPELL_ID then
    -- safe to use
end
```

Performing math, comparison, or string conversion on a secret value triggers an unrecoverable Lua error.

### Private Auras vs Secret Values
- **Private auras**: Boss mechanics marked as opaque. Always private, older system (pre-Midnight). Designed to block DBM/WeakAuras from tracking certain encounters.
- **Secret values**: Dynamic system added in Midnight. Aura data becomes secret based on context (combat/instance state). Same aura is accessible in overworld, secret in dungeon.

### Whitelist
Blizzard whitelists specific spells via bluepost announcements. No API to query the whitelist. Whitelisted spells return normal values in all contexts. Can change per patch.
